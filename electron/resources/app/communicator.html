<!DOCTYPE html>
<html>
<head>

	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="styles.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
</head>
<body onload="openTor();">
<body>
	<div id = "add_frnd_popup">
		<input type="text" placeholder="username" class="text" id="add_searchbar">
		<button id="add_frnd_button">add</button>
	</div>
	<div id="searchbox">
	<input type="text" placeholder="search" class="text" id="searchbar">
	<hr>
	</div>
	<div class="contacts" id="contacts">
		<div id = "add_frnd" onclick="document.getElementById('add_frnd_popup').style.display='block'"><img src="pics/Slimboi.png"></div>
	</div>

	<div id="profile">
		<span id="username"></span>
	</div>
	<div id="settings">
		<a href="settings.html"><img id="hentaispinner" src="pics/hentaispinner.png"></a>
	</div>

	<div id="chat">
	</div>

	<div class="send_div">
	<textarea type="text" placeholder="your message" class="text" id="message"></textarea>
	<button id="sendBtn">Send</button>
	</div>
	<script>
	window.addEventListener('click', function(e){

  	if (!document.getElementById('add_frnd_popup').contains(e.target) && !document.getElementById('add_frnd').contains(e.target)){
    		document.getElementById('add_frnd_popup').style.display = 'none';
  		}
		});

	function addBtn(text) {
	var element = document.createElement("button");
	element.innerText = text;
	element.className = "contact";
	element.onclick = function() {
		getPubkey(text);
	};

	var contacts = document.getElementById("contacts");
	contacts.insertBefore(element, contacts.childNodes[contacts.childNodes.length - 2]);
	}

	document.getElementById("add_frnd_button").onclick = function() {
		addBtn(document.getElementById("add_searchbar").value);
	};

	document.getElementById("sendBtn").onclick = function() {
		if (/\S/.test(document.getElementById("message").value)){
			addMsg(document.getElementById("message").value);
			document.getElementById("message").style.height = "46px";
			document.querySelector(".send_div").style.height = "61px";
			document.getElementById("chat").scrollTo(0,document.querySelector("#chat").scrollHeight);
			document.getElementById("message").value = "";
			console.log("ADDMSG(btn)")
		}
	};

	function addMsg(text) {
	var div1 = document.createElement("div");
	div1.className = ("msg1_div_1");
	var div2 = document.createElement("div");
	div2.className = ("msg1_div_2");
	var element = document.createElement("span");
	var chat = document.getElementById("chat");
	element.innerHTML = text;
	element.className = ("msg");
	if (chat.lastChild.className === "msg1_div_1" || chat.lastChild.className === "msg1_div_1 connectUp") {
		element.classList.add("connectUp");
		chat.lastChild.lastChild.lastChild.classList.add("connectDown");
	}
	div2.appendChild(element);
	div1.appendChild(div2);
	chat.appendChild(div1);
	sendMsg(text)
	}

	function addMsg2(text) {
	var div1 = document.createElement("div");
	div1.className = ("msg2_div_1");
	var div2 = document.createElement("div");
	div2.className = ("msg2_div_2");
	var element = document.createElement("span");
	var chat = document.getElementById("chat");
	element.innerHTML = text;
	element.className = ("msg2");
	if (chat.lastChild.className === "msg2_div_1" || chat.lastChild.className === "msg2_div_1 connectUp") {
		element.classList.add("connectUp2");
		chat.lastChild.lastChild.lastChild.classList.add("connectDown2");
	}
	div2.appendChild(element);
	div1.appendChild(div2);
	chat.appendChild(div1);
	}

	var input = document.getElementById("message");
	input.addEventListener("keyup", function(event) {
	if(event.keyCode == 13 && !event.shiftKey){
		if (/\S/.test(document.getElementById("message").value)){
			addMsg(document.getElementById("message").value);
			document.getElementById("message").style.height = "46px";
			document.querySelector(".send_div").style.height = "61px";
			document.getElementById("chat").scrollTo(0,document.querySelector("#chat").scrollHeight);
			document.getElementById("message").value = "";
			console.log("ADDMSG")
		}
	  }
	});

	var textarea = document.querySelector('textarea');
	var send_div = document.querySelector('.send_div');

	textarea.addEventListener('keydown', autosize);
	send_div.addEventListener('keydown', autosize);

	function autosize(){
		var el = this;
		setTimeout(function(){
		el.style.cssText = 'height:auto; padding:0';
		el.style.cssText = 'height:' + el.scrollHeight + 'px';
		},0);
}

	function getUser() {
		var path = require('path');
		var p = path.join(__dirname,'temp/user');

		var fs = require('fs');
		fs.readFile(p, 'utf8', function (err, data) {
		  if (err) return console.log(err);
			document.getElementById("username").innerText = data;
		});
	}
	window.onload = getUser();

	$('button', ".contacts").on('click', function(){
    $('button', ".contacts").not(this).removeClass('selected');
	if ($(this).hasClass('selected')) { $(this).removeClass('selected')}
	else { $(this).addClass('selected')}
	});

	</script>
	<script src="connect.js"></script>
</body>
</html>
